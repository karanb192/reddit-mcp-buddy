name: Test Publishing Pipeline

on:
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  test-publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for GitHub OIDC authentication
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Run unit tests
        run: npm test

      - name: Validate package.json
        run: |
          echo "Checking package.json configuration..."
          node -e "
          const pkg = require('./package.json');
          if (!pkg.name) throw new Error('Missing package name');
          if (!pkg.version) throw new Error('Missing package version');
          if (!pkg.mcpName) throw new Error('Missing mcpName field');
          if (pkg.mcpName !== 'io.github.karanb192/reddit-mcp-buddy') {
            throw new Error('Invalid mcpName: ' + pkg.mcpName);
          }
          console.log('âœ… package.json is valid');
          console.log('  Name:', pkg.name);
          console.log('  Version:', pkg.version);
          console.log('  MCP Name:', pkg.mcpName);
          "

      - name: Validate server.json
        run: |
          echo "Checking server.json configuration..."
          node -e "
          const fs = require('fs');
          const server = JSON.parse(fs.readFileSync('./server.json', 'utf8'));

          // Check required fields
          const required = ['name', 'version', 'description', 'packages'];
          for (const field of required) {
            if (!server[field]) throw new Error('Missing field: ' + field);
          }

          // Validate packages structure
          if (!server.packages || !Array.isArray(server.packages)) {
            throw new Error('Invalid packages array');
          }

          // Verify package name matches expected
          if (server.name !== 'io.github.karanb192/reddit-mcp-buddy') {
            throw new Error('Invalid server name: ' + server.name);
          }

          console.log('âœ… server.json is valid');
          console.log('  Name:', server.name);
          console.log('  Version:', server.version);
          console.log('  Packages:', server.packages.length);
          "

      - name: Test NPM publish (dry run)
        run: |
          echo "Testing NPM publish with --dry-run..."
          npm pack
          echo "âœ… Package can be built successfully"
          ls -lh *.tgz
          rm *.tgz

      - name: Test MCP Publisher installation
        run: |
          echo "Testing MCP Publisher tool build..."
          # Clone the MCP registry repo
          git clone https://github.com/modelcontextprotocol/registry.git /tmp/mcp-registry
          cd /tmp/mcp-registry

          # Build the publisher tool
          make publisher

          # Check if it built successfully
          if [ -f "./bin/mcp-publisher" ]; then
            echo "âœ… MCP Publisher built successfully"
            ./bin/mcp-publisher --help || echo "Help command output"
          else
            echo "âŒ MCP Publisher build failed"
            exit 1
          fi

      - name: Test MCP Registry authentication (mock)
        run: |
          echo "Would authenticate with: mcp-publisher login github-oidc"
          echo "Checking if server.json exists and is valid..."
          if [ -f "server.json" ]; then
            echo "âœ… server.json found"
            cat server.json | jq '.' > /dev/null && echo "âœ… server.json is valid JSON"
          else
            echo "âŒ server.json not found"
            exit 1
          fi

      - name: Validate build artifacts
        run: |
          echo "Checking build artifacts..."
          if [ -d "dist" ]; then
            echo "âœ… dist/ directory exists"
            ls -la dist/ | head -10
          else
            echo "âŒ dist/ directory not found"
            exit 1
          fi

          if [ -f "dist/cli.js" ]; then
            echo "âœ… dist/cli.js exists"
          else
            echo "âŒ dist/cli.js not found"
            exit 1
          fi

      - name: Build Desktop Extension (.mcpb)
        run: |
          chmod +x scripts/build-mcpb.sh
          ./scripts/build-mcpb.sh

      - name: Verify .mcpb file was created
        run: |
          if [ ! -f "reddit-mcp-buddy.mcpb" ]; then
            echo "Error: reddit-mcp-buddy.mcpb not found!"
            exit 1
          fi
          ls -lh reddit-mcp-buddy.mcpb
          echo "âœ… Desktop extension build verified"
          rm reddit-mcp-buddy.mcpb

      - name: Summary
        run: |
          echo "## ðŸ“‹ Publishing Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… package.json validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… server.json validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… NPM publish (dry run) successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… MCP Publisher CLI installed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build artifacts validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Desktop extension (.mcpb) built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure npm Trusted Publisher on npmjs.com" >> $GITHUB_STEP_SUMMARY
          echo "2. Create a version tag to trigger actual publishing" >> $GITHUB_STEP_SUMMARY